<!doctype html>
<html>

<head>
	<title>Line Chart with Custom Tooltips</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" type="text/css" href="../stuff/w3.css">
	<link rel="stylesheet" type="text/css" href="../stuff/font-awesome-4.5.0/css/font-awesome.css">
	<script type="text/javascript" src="../stuff/jquery1.12.js"></script>
	<script type="text/javascript" src="../stuff/moment.js"></script>
	<script type="text/javascript" src="../stuff/underscore.js"></script>
	<script src="../stuff/chart.js"></script>
	<script src="../stuff/clndr/src/clndr.js"></script>
	<script type="text/template" id="cal-template">
		<button class="clndr-today-button w3-btn w3-hover-light-grey">Heute</button>
		<div class="w3-row clndr-controls w3-row">
			<button class="clndr-previous-button w3-col m2 w3-btn w3-hover-light-grey"><i class="fa fa-angle-left fa-lg"></i></button>
			<div class="current-month w3-col m8"><h3><%= month %> <%= year %></h3></div>
			<button class="clndr-next-button w3-col m2 w3-btn w3-hover-light-grey"><i class="fa fa-angle-right fa-lg"></i></button>
		</div>
		<div>
			<div class="w3-row">
				<% _.each(daysOfTheWeek, function(day) { %>
					<div class="days-of-week w3-center"><%= day %></div>
				<% }); %>
			</div>
			<div class="w3-row">
				<% _.each(days, function(day) { %>
					<div class="clndr-days w3-center <%= day.classes %>" id="<%= day.date %>">
						<%= day.day %>
					</div>
				<% }); %>
			</div>
		</div>
		<!--<div class="event-listing">
			<div class="event-listing-title">EVENTS THIS MONTH</div>
			<% _.each(eventsThisMonth, function(event) { %>
				<div class="event-item">
					<div class="event-item-name"><%= event.date %>: <%= event.temp %> - <%= event.hum %></div>
				</div>
			<% }); %>
		</div>-->
	</script>
	<!--<script type="text/javascript" src="../stuff/zingChart/zingchart.min.js"></script>-->
	<!--<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>-->
</head>
<style type="text/css">
	h1{ text-align: center; }
	i{ cursor: pointer; padding-right: 0em !important;}

	div.popup{
		position: absolute;
		top: 25%;  bottom: 25%;  left: 5%; right: 5%;
		background-color: white;
		border-radius: 3px;
		overflow: auto;
		padding: 0em 2em 1em 2em;
	}
	div.popupClose{
		text-align: right;
		padding-top: 16px !important;
		padding-bottom: 16px !important;
	}
	/*canvas{ min-height: 300px; }*/
	
	#liveData{ margin: 0 !important; padding: 0 !important; }
	#liveData h3{ margin: 0 !important; }

	#liveData div{
		min-height: 175px;
		line-height: 175px;
	}
	#liveData i{ padding-right: 0.5em !important; }
	#myChart{height: 100%;width: 100%;}
	#chart_div{ position: relative !important; }
	#status{ margin: 1 2em; }
	#lastId{ display: none; }

	.clndr-controls{ 
		height: 20px; line-height: 20px;
	}
	.clndr-control button{ background-color: inherit !important; color: inherit !important; }
	.clndr-controls h3{
		padding: 0 !important;
		margin: 0 !important;
	}
	.days-of-week, .clndr-days{ width: 14.28%; float: left; height: 40px; line-height: 40px; overflow: auto;}

	.days-of-week{ font-weight: bold;}

	.clndr-previous-button, .clndr-next-button, .current-month{
		text-align: center;
	}
	.clndr-previous-button, .clndr-next-button{
		cursor: pointer;
	}
	.clndr-previous-button:hover, .clndr-next-button:hover{
		background-color: black;
		color: white;
	}
	.last-month, .next-month{ visibility: hidden; }
	.event{ cursor: pointer; font-weight: bold;}
	.event:hover{ text-decoration: underline; }

	@media all and (min-device-width: 601px){
		#cal{ height: 350px; overflow: auto;}
	}
	@media all and (orientation: portrait){
		
	}
</style>

<body>
	<h1>Temps</h1>
	<div class="w3-image">
		<div id="chart_div"></div>
	</div>
	<p class="test">Test</p>
	<div class="w3-modal" id="averagePopup">
		<div class="popup">
			<div class="popupClose">
				<i class="fa fa-close fa-2x"></i>
			</div>
			<h2>Datum</h2><hr>
			<div class="w3-row">
				<div class="w3-half" id="averageTemp">Durchschnittliche Temperatur <h3></h3></div>
				<div class="w3-half" id="averageHum">Durchschnittliche Luftfeuchtigkeit<h3></h3></div>
			</div>
		</div>
	</div>

	<div class="w3-row">
		<div class="w3-center">
			<div id="cal" class="w3-half w3-dark-grey"></div>
			<div class="w3-half" id="liveData">
				<div class="liveTemp">
					<h3><i class="fa fa-asterisk"></i><span>Temperatur</span> &deg;C</h3>
				</div>
				<div class="liveHum">
					<h3><i class="fa fa-tint"></i><span>Luftfeuchtigkeit</span> %</h3>
				</div>
			</div>
		</div>
	</div>
	<div class="w3-padding-xxlarge w3-center" id="status"></div>
	<div class="w3-rows" id="charts">
		<div class="w3-container w3-half"><canvas id="tempChart"></canvas></div>
		<div class="w3-container w3-half"><canvas id="humChart"></canvas></div>
	</div>
	<p id="lastChartId">Last Chart ID</p>
	<button class="start">Start</button>
	<button class="stop">Stop</button>
	<!--<canvas id="tempChart"></canvas>
	<canvas id="humChart"></canvas>-->

	<script type="text/javascript">
	Chart.defaults.global.pointHitDetectionRadius = 1;
	Chart.defaults.global.responsive = true;
	//Chart.defaults.global.animation = false;
	//Chart.defaults.global.scaleStepWidth = 4;
	
	var randomScalingFactor = function() {
		return Math.round(Math.random() * 100);
	};

	var months = ["January", "February", "March"];
	var test = [];

	function showCharts(limit, month, dataArray, colors, selectors){

		$.get("functions.php",{ function: "show", limit: limit, type:"init", month: month }, function(data){
			if (data[0].noEntry){
				alert("Keine Einträge in der Datenbank!");
				$("#lastChartId").attr("class", 0);
			}
			else{
				drawLineChart(data, dataArray, colors, selectors, false);
			}
			
		}).done(function() {

			
		});
	}

	function drawLineChart(data, dataArray, colors, selectors, shiftElements){

		$.each(data, function(i){
			var date = new Date(data[i].tstamp);

			dataArray.dates.push( moment( data[i].tstamp ).format("HH.mm.ss") );
			dataArray.temps.push( parseFloat(data[i].temp) );
			dataArray.hums.push( parseFloat(data[i].hum) );

			if( shiftElements ){


				for (var i = 0; i < 1; i++){
					dataArray.dates.shift();
					dataArray.temps.shift();
					dataArray.hums.shift();
				}
			}
		});
		var test = data[data.length-1].tstamp;

		$("#lastChartId").attr("class", test).html(test);
		
		//$("#lastChartId").attr("class", data[data.length-1].id).html(data[data.length-1].id);

		var tempContainer = $( selectors[0] ).get(0).getContext("2d");
		var tempChart = new Chart(tempContainer).Line( generateData(dataArray.dates, dataArray.temps, colors.temps),{
			tooltipTemplate: "Temperatur <%=label%>: <%= value %> Grad"
		});

		var humContainer = $( selectors[1] ).get(0).getContext("2d");
		var humChart = new Chart(humContainer).Line( generateData(dataArray.dates, dataArray.hums, colors.hums), {
			tooltipTemplate: "Luftfeuchtigkeit um <%=label%>: <%= value %>%"
		});

		return [tempChart, humChart];
	}

	function getLiveCharts(limit, month, tstamp, dataArray, colors, selectors){
		

			$.get("functions.php",{ function: "show", limit: limit, tstamp: tstamp, type: "live", month: month }, function(data){
				if (data[0].noEntry){
					$("div#status").html("Keine Einträge in der Datenbank!").removeClass("w3-green").addClass("w3-red");
					$("#lastChartId").attr("class", 0);
				}
				else{
					$("div#status").html("Status OK").addClass("w3-green");
					drawLineChart(data, dataArray, colors, selectors, true);
				}
			});
		
	}

	function getLiveData(selector){
		$.get("functions.php",{ function: "last" }, function(data){
			if (data[0].noEntry){
				alert("Keine weiteren Einträge in der Datenbank!");
			}
			else{
				$(selector).first().html( data[0].temp );
				$(selector).last().html( data[0].hum );
			}
		});
	}

	function getAverages(calendar, month){
		
		$.get("functions.php",{ function: "getAverages", month: month }, function(data){
			if (!data[0].noEntry){
				var averages = [];
				$.each(data, function(i){
					averages.push({
						date: data[i].tstamp.slice(0, 10),
						temp: Math.round(parseFloat(data[i].temp)),
						hum: Math.round(parseFloat(data[i].hum))  
					});
				});

				calendar.setEvents(averages);

				$(".event").click(function(){
					var date = moment( parseInt( $(this).attr("id") ) ).format("YYYY-MM-DD");

					for (var i = 0; i<averages.length; i++){
						if(averages[i].date == date){
							$("#averagePopup h2").html( moment(date).format("DD.MM.YYYY") );
							$("#averageTemp h3").html( averages[i].temp +" &deg;C");
							$("#averageHum h3").html( averages[i].hum + " %");
							$("#averagePopup").show();
						}
					}
				});
			}
		});
	}

	function formatDate(date){
		if(date){
			var dates = date.split(/[- :]/);
			return dates[3]+"."+dates[4]+"."+dates[5];
			//return dates[2]+"."+dates[1]+"."+dates[0]+" um "+dates[3]+":"+dates[4]+":"+dates[5];
		}
	}

	function gaugeChart(value){

		var myConfig1 = {
			"type":"gauge", 
			"series":[
				{"values":[value]}
			]
		};

		zingchart.render({ 
			id : 'myChart', 
			data : myConfig1, 
			height : "100%", 
			width: "100%" 
		});
	}

	function generateData(dates, values, colors){
		var data = {
			labels: dates,
			datasets: [{
				fillColor: colors[0],
				strokeColor: colors[1],
				pointColor: "rgba(220,220,220,1)",
				pointStrokeColor: "#fff",
				pointHighlightFill: "#fff",
				pointHighlightStroke: "rgba(220,220,220,1)",
				data: values
			}]
		};
		return data;
	}

	$(document).ready(function(){

		var currentMonth = moment().format("M");

		var calendar = $('#cal').clndr({
			template: $("#cal-template").html(),
			weekOffset: 1,
			daysOfTheWeek: ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'],
			clickEvents: {
				onMonthChange: function(month){
					//alert( moment(month).format("M") );
					getAverages( calendar, moment(month).format("M") );
				},
				today: function(month){ 

				}
			},
			targets: {
				nextButton: 'clndr-next-button',
				previousButton: 'clndr-previous-button',
				todayButton: 'clndr-today-button',
				day: 'day',
				empty: 'empty'
			},
			
			//adjacentDaysChangeMonth: false,
			forceSixRows: true
		});

		getAverages( calendar, currentMonth );

		var datesArray = [];
		var tempsArray = [];
		var humsArray = [];
		var selectors = ["#tempChart", "#humChart"];

		var limit = 5;

		var data = {
			dates: [],
			temps: [],
			hums: []
		};

		var colors = {
			temps: ["tomato", "white"],
			hums: ["lightblue", "white"]
		};

		var parametersInit = {
			function: "show",
			limit: limit,
			type: "init"
		};

		var parametersLive = {
			function: "show",
			limit: limit,
			type: "live"
		};

		showCharts(limit, currentMonth, data, colors, selectors);

		var interval;
		var counter = 0;

		$(".liveTemp").css("background-color", colors.temps[0]).css("color", colors.temps[1]);
		$(".liveHum").css("background-color", colors.hums[0]);

		$("button.start").click(function(){

			interval = setInterval(function(interval){

				getLiveData("#liveData h3 span");
				
				counter++;
				if( counter%3 == 0 ){
					if($("#lastChartId").attr("class") != 0){
						getLiveCharts( limit, currentMonth, $("#lastChartId").attr("class"), data, colors, selectors);
					}
				}
			}, 1000);
		});

		$("button.stop").click(function(){
			clearInterval(interval);
			
		});
		$("#cal div.event").click(function(){
			( $(this).text() );
			$("div#averagePopup").css("display", "block");
		});
		$("i.fa-close").click(function(){
			$(this).parents(".w3-modal").css("display", "none");
		});
	});

	</script>
</body>

</html>